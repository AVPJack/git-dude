#!/bin/bash

interval=$(git config dude.interval)
interval=${interval:-60}

icon_path=$(git config dude.icon)
icon_path=${icon_path:-`pwd`/icon.png}
eval icon_path=$icon_path # to expand ~

export LC_ALL=C # make sure git talks english

[[ -d $1 ]] && cd $1

function notify() {
  if [ $(which notify-send 2>/dev/null) ]; then
    notify-send -i "$1" "$2" "$3"
  elif [ $(which growlnotify 2>/dev/null) ]; then
    growlnotify -l "$1" -m "$3" "$2"
  else
    echo $2; echo $3
  fi
}

while true; do
  echo -n .

  for dir_name in *; do
    if [[ -d $dir_name ]]; then
      repo_name=$(basename $dir_name .git)
      cd $dir_name

      changes=$(git fetch -v 2>&1 | grep -F -- '->')

      while read -r line; do
        case $line in
          *..*)
            commit_range=$(echo "$line" | awk '{ print $1 }')
            branch_name=$(echo "$line" | awk '{ print $2 }')
            commit_messages=$(git log $commit_range --pretty=format:'%s (%an)')
            notify $icon_path "New commits in $repo_name/$branch_name" "$commit_messages"
            ;;
          *new*)
            branch_name=$(echo "$line" | awk '{ print $4 }')
            notify $icon_path "New branch $repo_name/$branch_name"
            ;;
        esac
      done <<< "$changes"

      cd - &>/dev/null
    fi
  done

  sleep $interval
done
